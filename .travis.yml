dist: bionic
sudo: false
branches:
  except:
    - gh-pages
notifications:
  email:
    recipients:
      - gluecodium_team@here.com
    on_success: never # default: change
    on_failure: always # default: always
addons:
  apt:
    packages:
      - ninja-build
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache
jobs:
  include:
    - stage: compile
      name: "Build and unit tests"
      language: java
      before_script:
        - echo "Travis branch '$TRAVIS_BRANCH' from pull request '$TRAVIS_PULL_REQUEST'."

    # TODO: don't build the main binary again
    - stage: test
      name: "C++ functional tests"
      language: cpp
      addons:
        apt:
          packages:
            - valgrind
      before_script:
        - cd examples      
      script:
        - ./scripts/build-cpp --valgrind

    - stage: test
      name: "Android functional tests"
      language: java      
      before_install:
        - export ANDROID_HOME=~/android-sdk-linux
        - export ANDROID_NDK_HOME=${ANDROID_HOME}/ndk-bundle
        - export SDK_ROOT=${ANDROID_HOME}
        - export NDK_ROOT=${ANDROID_NDK_HOME}
        - export PATH=${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools
      install:
        - ANDROID_API_LEVEL=android-28
        - ANDROID_BUILD_TOOLS_VERSION=28.0.3
        - ANDROID_CMAKE_VERSION=3.10.2.4988404      
        - wget -q "https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip" -O android-sdk-tools.zip
        - unzip -q android-sdk-tools.zip -d ${ANDROID_HOME}
        - rm android-sdk-tools.zip
        - mkdir -p ~/.android
        - touch ~/.android/repositories.cfg
        - yes | sdkmanager --licenses
        - yes | sdkmanager "platforms;${ANDROID_API_LEVEL}" > /dev/null
        - yes | sdkmanager "build-tools;${ANDROID_BUILD_TOOLS_VERSION}" > /dev/null
        - yes | sdkmanager "cmake;${ANDROID_CMAKE_VERSION}" > /dev/null
      before_script:
        - cd examples
      script:
        - ./scripts/build-android --hostOnly
        
    - stage: test
      name: "Swift functional tests"
      language: cpp
      addons:
        apt:
          packages:
            - valgrind
      install:
        - SWIFT_BRANCH=swift-5.1.3-release
        - SWIFT_VERSION=swift-5.1.3-RELEASE
        - SWIFT_PLATFORM=ubuntu18.04
        - SWIFT_ARCHIVE_NAME=${SWIFT_VERSION}-${SWIFT_PLATFORM}
        - SWIFT_URL=https://swift.org/builds/${SWIFT_BRANCH}/$(echo "${SWIFT_PLATFORM}" | tr -d .)/${SWIFT_VERSION}/${SWIFT_ARCHIVE_NAME}.tar.gz
        - wget -nv ${SWIFT_URL}
        - tar xf ${SWIFT_ARCHIVE_NAME}.tar.gz --directory / --strip-components=1
        - rm -rf ${SWIFT_ARCHIVE_NAME}*
        - chmod -R o+r /usr/lib/swift/CoreFoundation
      before_script:
        - cd examples      
      script:
        - ./scripts/build-swift --valgrind     
